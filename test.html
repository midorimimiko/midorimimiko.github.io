<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>記錄檢視器</title>
    <style>
        body {
            margin: 0;
            font-family: 'M PLUS 1p', sans-serif;
            line-height: 5;
        }

        .container {
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .record-button {
            width: 100%;
            padding: 10px 15px;
            background: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .record-button:hover {
            background-color: #f5f5f5;
        }

        .final-record-button {
            width: 100%;
            padding: 10px 15px;
            background: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            display: none;
            margin-top: 20px;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .final-record-button:hover {
            background-color: #f5f5f5;
        }

        .close-record-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            z-index: 1101;
        }

        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            z-index: 999;
        }

        .background-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .background-overlay.fade-out {
            opacity: 0;
            visibility: hidden;
        }

        /* 彈出區塊樣式 */
        .overlay {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            width: 830px;
            height: 300px;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: #000000;
            background-image: radial-gradient(rgba(66, 195, 200, 0.2), #1d1e22 120%);
            color: #ffffff;
            font: 1.3rem Inconsolata, monospace;
            text-shadow: 0 0 5px #FFFFFF;
            box-shadow: 0 0 20px rgba(66, 195, 200, 0.5),
                        0 0 40px rgba(66, 195, 200, 0.3),
                        0 0 60px rgba(66, 195, 200, 0.2);
            overflow: hidden;
        }

        .overlay::after {
            content: "";
            position: absolute;
            opacity: 0.3;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(0deg, black, black 2px, transparent, transparent 4px);
            pointer-events: none;
        }

        .overlay::before {
            content: "";
            position: absolute;
            z-index: 1000;
            opacity: 0.4;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at right 34% bottom 5%, transparent 60%, #000000);
            pointer-events: none;
        }

        .wrapper {
            height: 100%;
            padding: 2rem;
            overflow-y: auto;
            max-height: 100%;
        }

        .wrapper::-webkit-scrollbar {
            display: none;
        }

        pre {
            margin: 0;
            white-space: pre-wrap;
            line-height: 1.5;
            animation: text-blink 0.01s steps(2) infinite;
        }

        pre:last-of-type {
            padding-bottom: 2rem;
        }

        @keyframes text-blink {
            from, to { opacity: 1; }
            50% { opacity: 0.8; }
        }

        @keyframes blink {
            from, to { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .close-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: none;
            z-index: 1001;
        }

        .censor-text {
            cursor: pointer;
            color: #A82426;
            text-shadow: 0 0 5px #A82426;
            background-color: transparent;
            transition: color 0.3s ease, text-shadow 0.3s ease;
        }
        .censor-text.revealed {
            color: #ffffff;
            text-shadow: 0 0 5px #ffffff;
        }
        .censor-text:hover {
            opacity: 0.8;
        }

        [id^="output"]:after {
            content: "▮";
            opacity: 0;
            animation: none;
        }

        [id^="output"].active-cursor:after {
            opacity: 1;
            animation: blink 1s steps(1) infinite;
        }

        [id^="output"].gw-writing:after {
            animation: none;
            opacity: 1;
        }

        @keyframes crt-off {
            0% {
                transform: translate(-50%, -50%) scale(1, 1);
                filter: brightness(1);
                opacity: 1;
            }
            60% {
                transform: translate(-50%, -50%) scale(1, 0.001);
                filter: brightness(0.8);
                opacity: 0.8;
            }
            100% {
                transform: translate(-50%, -50%) scale(0, 0.001);
                filter: brightness(0);
                opacity: 0;
            }
        }

        @keyframes crt-lines {
            0% { background-position: 0 0; }
            100% { background-position: 0 25px; }
        }

        .overlay.closing {
            animation: crt-off 0.6s cubic-bezier(.4,0,.2,1) forwards,
                       crt-lines 0.2s linear infinite;
            background-image: 
                radial-gradient(rgba(66, 195, 200, 0.2), #1d1e22 120%),
                repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.5) 0, rgba(0, 0, 0, 0.5) 1px, transparent 1px, transparent 2px);
            background-size: 100% 100%, 100% 25px;
        }

        .record-button.active {
            background-color: #f5f5f5;
        }

        /* ─── 章節閱覽區 ─── */
        .record-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1000;
            overflow-y: auto;
        }

        .record-content {
            max-width: 800px;
            margin: 60px auto 40px;
            padding: 20px 40px;
            line-height: 1.8;
            white-space: pre-line;
            min-height: calc(100vh - 100px);
        }

        .record-overlay::-webkit-scrollbar { width: 8px; }
        .record-overlay::-webkit-scrollbar-track { background: #f1f1f1; }
        .record-overlay::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .record-overlay::-webkit-scrollbar-thumb:hover { background: #555; }

        [id^="output"] { color: white; }

        /* ─── 主頁面左側全域按鈕 ─── */
        .global-side-buttons {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 500; /* 主頁面層，低於 record-overlay */
        }

        .global-side-btn {
            padding: 12px 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
            white-space: nowrap;
            /* 初始隱藏，用 JS 控制顯示 */
            opacity: 0;
            pointer-events: none;
            transform: translateX(-10px);
        }

        .global-side-btn.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
            transition: opacity 0.4s ease, transform 0.4s ease, background-color 0.2s ease, border-color 0.2s ease;
        }

        .global-side-btn:hover {
            background-color: #f5f5f5;
            border-color: #999;
        }

        .global-side-btn.active {
            background-color: #333;
            color: white;
            border-color: #333;
        }

        /* ─── 主頁面右側面板 ─── */
        .global-side-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 400px;
            height: 100%;
            background: #f9f9f9;
            border-left: 1px solid #ddd;
            z-index: 500;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }

        .global-side-panel.active {
            transform: translateX(0);
        }

        .global-side-panel-content {
            padding: 60px 30px 40px;
            line-height: 1.8;
        }

        .global-side-panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .global-side-panel-text {
            white-space: normal;
            font-size: 14px;
            line-height: 1.8;
            color: #444;
        }

        .global-side-panel-text img {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 4px;
            margin: 10px 0;
        }

        .global-panel-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 22px;
            cursor: pointer;
            color: #666;
            line-height: 1;
        }
        .global-panel-close:hover { color: #000; }

        /* ─── NEW 標籤 ─── */
        .global-side-btn .new-badge {
            display: inline-block;
            margin-left: 6px;
            padding: 1px 5px;
            /* ─── background: #e02020;─── */
            color: #000;
            font-size: 10px;
            /* ─── font-weight: bold;─── */
            border-radius: 3px;
            letter-spacing: 0.5px;
            vertical-align: middle;
            line-height: 1.5;
            animation: badge-pop 0.3s cubic-bezier(.4,1.6,.6,1) both;
        }

        @keyframes badge-pop {
            from { transform: scale(0.5); opacity: 0; }
            to   { transform: scale(1);   opacity: 1; }
        }

        .global-side-panel::-webkit-scrollbar { width: 8px; }
        .global-side-panel::-webkit-scrollbar-track { background: #f1f1f1; }
        .global-side-panel::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .global-side-panel::-webkit-scrollbar-thumb:hover { background: #555; }

        /* ─── 淡入淡出文字效果 ─── */
        .fade-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
            z-index: 1100;
            pointer-events: none;
        }

        .fade-line {
            font-size: clamp(0.8em, 2vw, 1.5em);
            font-weight: bold;
            text-align: center;
            line-height: 1.6;
            opacity: 0;
            transition: opacity 1s ease;
            padding: 0 24px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .record-content.hidden-content {
            visibility: hidden;
        }
    </style>
</head>
<body>

    <!-- 主頁面章節按鈕 -->
    <div class="container">
        <div class="button-container">
            最後更新 13:53
        </div>
        <button class="final-record-button">某個科學家留下的紀錄</button>
    </div>

    <!-- 主頁面左側全域按鈕（看完章節後出現） -->
    <div class="global-side-buttons" id="globalSideButtons"></div>

    <!-- 主頁面右側說明面板 -->
    <div class="global-side-panel" id="globalSidePanel">
        <button class="global-panel-close" id="globalPanelClose">×</button>
        <div class="global-side-panel-content">
            <div class="global-side-panel-title" id="globalPanelTitle"></div>
            <div class="global-side-panel-text"  id="globalPanelText"></div>
        </div>
    </div>

    <!-- 章節閱覽 overlay -->
    <div class="record-overlay">
        <button class="close-record-button">×</button>
        <div class="record-content"></div>
    </div>

    <div class="background-overlay"></div>

    <!-- 科學家紀錄打字機 -->
    <div class="overlay">
        <button class="close-button">×</button>
        <div class="wrapper">
            <pre><span id="output1"></span><span class="cursor"></span></pre>
            <pre><span id="output2"></span><span class="cursor"></span></pre>
            <pre><span id="output3"></span><span class="cursor"></span></pre>
            <pre><span id="output4"></span><span class="cursor"></span></pre>
            <pre><span id="output5"></span><span class="cursor"></span></pre>
            <pre><span id="output6"></span><span class="cursor"></span></pre>
            <pre><span id="output7"></span><span class="cursor"></span></pre>
        </div>
    </div>

<script type="module">
    import GlitchedWriter, { wait, presets } from "https://cdn.skypack.dev/glitched-writer@2.0.29";

    // ─────────────────────────────────────────────────────────────────
    // 全域按鈕定義
    // 每個按鈕可有多個「版本」，版本會被後續章節覆蓋
    // versions 的 key 名稱可自訂，只要 chapterEffects 裡對應即可
    // ─────────────────────────────────────────────────────────────────
    const globalButtonDefs = {
        btn1: {
            label: "蘿絲",
            versions: {
                default: {
                    title: "人物介紹：蘿絲",
                    content: `這是一段註解內容<br>可以提供額外的說明<br>或背景資訊`
                },
                afterCh3: {
                    title: "相關註解（更新）",
                    content: `閱讀過 Chapter 3 後更新的蘿絲相關資料<br><br>提供了更多背景`
                }
            }
        },
        btn2: {
            label: "艾格雷瓦",
            versions: {
                default: {
                    title: "人物介紹：艾格雷瓦",
                    content: `這裡是補充資料<br><br>
                    <img src="https://emos.plurk.com/fac543fc42564c9edcf3a64ffce2297b_w48_h48.png"><br>
                    提供更多細節，幫助理解主文`
                },
                afterCh3: {
                    title: "補充資料（更新）",
                    content: `閱讀過 Chapter 3 後更新的艾格雷瓦資料<br><br>有了新的發現`
                }
            }
        },
        btn3: {
            label: "娜塔莎",
            versions: {
                default: {
                    title: "人物介紹：娜塔莎",
                    content: "Chapter 2 的特別說明"
                }
            }
        },
        btn4: {
            label: "詩米雷",
            versions: {
                default: {
                    title: "人物介紹：詩米雷",
                    content: "Chapter 4 的特別說明"
                }
            }
        }
        // ── 需要新增按鈕時，在此繼續新增 ──
    };

    // ─────────────────────────────────────────────────────────────────
    // 章節完成效果設定
    // show        : 該章節看完後，要「顯示」哪些按鈕（首次出現）
    // updateVersion: 要把哪些按鈕切換到哪個版本
    //               （無論按鈕當下是否已顯示都會套用）
    // ─────────────────────────────────────────────────────────────────
    const chapterEffects = {
        0: { show: ["btn1", "btn2"], updateVersion: {} },          // Chapter 1
        1: { show: ["btn3"],         updateVersion: {} },          // Chapter 2
        2: { show: [],               updateVersion: { btn1: "afterCh3", btn2: "afterCh3" } }, // Chapter 2.5
        3: { show: ["btn4"],         updateVersion: {} }           // Chapter 3
        // ── 需要新增章節效果時，在此繼續新增 ──
    };

    // ─────────────────────────────────────────────────────────────────
    // 章節內容定義（移除各章節的 sideButtons，改由主頁面統一管理）
    // ─────────────────────────────────────────────────────────────────
    const recordContents = [
        {
           title: "Chapter 1",
            fadeLines: [
                { text: "據說在很久很久以前，人類和天使以及惡魔\n曾和平共存於同一片大地之上", stay: 6000 },
                { text: "可後來卻發生戰爭\n三個種族便分別在各自的世界生活，不再往來", stay: 5000 },
                { text: "由於所遺留下來可供佐證的相關文獻過少\n這段傳說普遍被認為是古人所創作的幻想……", stay: 8000 }
            ],
            content: `「──而我認為這或許是古代所流行的宗教信仰，甚至是某種被集體抹除的歷史紀錄，畢竟信仰的誕生必然有其物理上的原型，如此一來……艾格？你有在聽嗎？」

「有啊」艾格雷瓦托著下巴，視線漫不經心地掃向攤滿桌上的羊皮紙，「爛大街ACG作品一樣的設定」

蘿絲放下手中的資料，無奈地嘆了口氣：「真是的，到底是誰的作業啊……我可是犧牲了自己的午休時間，還把專業知識傾囊相授給你耶！」

「我只是說學校要做自由專題研究，問妳這邊有沒有什麼好寫的主題，」艾格雷瓦語氣平靜地反駁，「然後妳就雙眼放光，像傳教士一樣自顧自地講起來了」

蘿絲再度嘆氣，這次帶著幾分說不清道不明的沉重

「爸媽前陣子又在勸我……說我應該帶著你和他們一起到國外經營服裝店」她的聲音輕了下來，「艾格，你也覺得我該換個工作、別再抱有不切實際的幻想了嗎？」

「問我幹嘛？」艾格雷瓦將視線從那些泛黃的文字移開，直直地看著蘿絲的雙眼，「這是妳自己的人生，妳想做什麼自己決定，別人既不會、也沒有義務為妳的人生負責——管他們怎麼說？」

這話說得冷硬，卻是他最真實的生存哲學

蘿絲一愣，隨即笑著伸手揉了揉艾格雷瓦的頭髮，「你這話說的，活像個人生經歷豐富的大人一樣」

艾格雷瓦翻了個白眼，「妳這習慣該改改了，別老把我當小孩」

「在我眼裡你就是小孩，不管是以前還是現在」

蘿絲收回手，眼神卻不自覺地飄向艾格雷瓦那截露在袖口外的、曾因意外留下淡淡疤痕的手腕

即便傷口早已癒合，卻依然像一道無法抹去的陰影，提醒著她眼前這個少年曾受過多大的苦難


那時他們還只是鄰居

自從艾格雷瓦的母親留下巨額債務、在那場連綿的小雨中人間蒸發後，那個原本就不健全的家便徹底崩塌

隔壁牆後時常傳來酒瓶破碎的清脆聲、男人含糊不清的咆哮，以及重物撞擊牆壁時那種令人心驚膽顫的沉悶聲響

若非當時蘿絲的父母強行介入，並在幾年後正式收養了他，艾格雷瓦大概早就成了這座城市某個陰暗角落裡的無名碎片

儘管後來蘿絲的父母決定去國外經營生意，將那間舊公寓留給了剛出社會的蘿絲和正在升學的艾格雷瓦，他們仍經常關心著蘿絲與艾格雷瓦的生活情況


「如果我真的聽爸媽的話去國外，你也會跟著去嗎？」蘿絲突然問道，語氣裡藏著一絲連她自己都沒察覺的試探

「我去那邊幹嘛？幫忙燙衣服還是當模特兒？」艾格雷瓦自嘲地扯了扯嘴角，「再說，妳真的捨得這些妳所謂的『真相』嗎？」

「我……啊，等我一下」蘿絲的話語被她工作用的手機鈴響打斷，她不好意思地向艾格雷瓦比了個稍等的手勢後便接起電話，「喂？是的、對……現在嗎？好，我馬上過去，」

蘿絲一邊對著電話點頭，一邊手忙腳亂地將散亂的羊皮紙收進包裡，臉上寫滿了糾結與歉意，「抱歉，艾格，我突然有急事得先去處理……你先自己慢慢看吧，有什麼問題等我回來再跟你討論，或者你如果看了其他的展示想換主題也──」

「行了，妳快去吧」艾格雷瓦揮了揮手，語氣裡聽不出遺憾，倒像是終於從一場漫長的布道中解脫出來


看著蘿絲那充滿活力卻又冒失的身影消失在走廊盡頭，艾格雷瓦百無聊賴地靠向椅背，盯著桌上七零八落的草稿

其實對他來說，研究主題到底是什麼根本無所謂，既然是學校交代的自由專題，只要最後能湊滿字數準時交差就行，既然蘿絲對這神話研究這麼熱衷，那他剛好樂得輕鬆

反正內容隨便她塞，他只要負責謄寫就好

艾格雷瓦慢條斯理地收拾好桌上的文具，決定在等蘿絲回來的這段時間四處晃晃，或許能找到比這疊陳舊羊皮紙更讓他感興趣的打發時間方式




這座市立博物館座落在舊城區的邊緣，建築本身早已顯得老態龍鍾，剝落的牆皮與時好時壞的照明系統無不彰顯著經費的拮据

由於今日並非假日，館內除了幾名在服務台打瞌睡的志工外，幾乎看不見任何安保人員，甚至連監視器的指示燈都透著一股隨時會熄滅的無力感

這種近乎荒廢的寬鬆管理，讓艾格雷瓦在閒逛時完全沒有被干涉的顧慮


或許是博物館內的空調太冷，也或許是剛才那陣沉悶的討論讓他有些昏沉，在去完洗手間的回程中，原本應該右轉進入主展廳的艾格雷瓦不知不覺間走入了一條狹窄且燈光昏暗的長廊

走廊兩側不再是精美的玻璃展示櫃，取而代之的是沉重的金屬防火門，牆上的標示也從「參觀動線」變成了冷冰冰的「非工作人員禁止進入」

當他意識到自己可能誤入了藏品庫房或是某個尚未開放的整裝區時，他停下腳步，微微皺眉


面前是一扇半掩著的厚重木門，門上掛著一塊鏽跡斑斑、字跡模糊的「禁止入內」牌子，但鎖頭卻是鬆開的

門縫透出一抹微光，與之伴隨而來的還有一陣刻意壓低的少女嗓音──

「我知道啦！我晚上就會把雕像的事處理完，放心交給我好嗎？」

艾格雷瓦停在門前，原本抬起手打算敲門致歉，但隨即想到這地方既然無人看管且門也沒鎖，似乎也沒必要表現得太過拘謹

他推開門，原本以為會看到某個忙碌的工讀生，卻在視線交會的瞬間愣在原地


在那堆雜亂的石膏像與包裝箱之間，站著一名外表與常人無異的少女

然而她背後那一對漆黑如墨的羽翼，在昏暗的微光下顯得極其不真實

少女驚訝地轉過身，那對黑色翅膀在轉瞬間化作無數黑色的流光，消失在空氣中，空氣陷入了幾秒鐘死一般的寂靜

「呃哈哈、你好？這裡、這裡的雕像很特別呢！」少女乾笑著開口，額角流下一滴冷汗

「是啊，那個……妳好？」艾格雷瓦面上波瀾不驚，內心卻在懷疑是不是剛才羊皮紙看太多導致出現了視覺殘留

「……你看到了對不對？」少女沉默了許久，像是終於下定了某種必死的決心，語氣沉重地問道

「看到什麼？」

「翅膀！惡魔的黑色翅膀啊！還有耳朵！尖的！」她近乎自暴自棄地喊了出來

「哦，所以剛才果然不是我眼花啊」艾格雷瓦的回應平淡得像是剛確認完天氣預報，「妳不說我還沒注意到妳耳朵是尖的」

「有什麼好眼花的，我怎麼看都像是個邪惡的惡魔好嗎！」少女惱火地反駁，但很快又陷入了某種焦慮的自言自語，「不對，人類不應該發現的，這下麻煩了……」

「呃……我明白每個人都有中二的時候，而且自嗨的時候剛好被人撞到確實是會讓人感到非常的羞恥跟尷尬，不過不要緊我不是那種會到處跟人說的大嘴巴，再說我們也不認識，別放在心上」艾格雷瓦試圖用他那套現實主義的邏輯去解讀眼前的異狀，並轉身打算離開這個是非之地

「中二？什麼意思？不對、不管這個了！」少女突然衝上前抓住艾格雷瓦的手，力道大得驚人，「既然規定不能殺了人類，那我也只能把你藏起來了」

艾格雷瓦皺著眉試圖抽回被抓住的手腕，那裡正好他曾經受過傷的地方，然而對方的指尖卻像鐵鉗一樣死死扣住

「妳幹嘛！」

「我叫娜塔莎，到了那邊乖乖聽我的話，對我們兩個都有好處，聽懂了嗎？」名為娜塔莎的少女背後再度出現那漆黑的羽翼，臉上的表情與其說是威脅，倒更像是闖了大禍後試圖掩蓋的窮途末路

艾格雷瓦停止了無謂的掙扎，他看著那對漆黑的翅膀，又想起蘿絲提到的、被他調侃為爛大街ACG設定的傳說，最後只能發出一聲長長的、充滿妥協意味的嘆息

「知道了，麻煩溫柔一點，我怕疼」`
        },
        {
            title: "Chapter 2",
            content: `娜塔莎帶著艾格雷瓦穿過那道扭曲的空間裂縫時，艾格雷瓦只覺得胃部一陣翻攪，隨即整個人被粗暴地塞進了一個狹窄、充滿樟腦與乾洗劑氣味的空間

巨大的衝擊力讓衣櫃裡的木質層板發出不堪重負的吱呀聲，散發著淡淡樟腦味與塵埃的洋裝如落花般覆蓋在艾格雷瓦身上

「……咳、說好的溫柔呢？」艾格雷瓦狼狽地從一堆蕾絲與綢緞中撐起身體，在撥開擋住視線的黑色洋裝時手肘還不小心撞到了木質背板，發出沉悶的響聲

「閉嘴，如果被其他惡魔發現，你就等著被綁在審訊室的鐵椅上了！」娜塔莎喘著粗氣，手忙腳亂地把私密衣物往角落踢，試圖掩蓋這尷尬的混亂，「這裡是我家，我一個人住，只要你不出聲，應該沒人會發現你──至少目前是這樣，等這陣子風頭過了……」

「所以，妳要軟禁我？」艾格雷瓦打斷了她的話，他漫不經心地捏起地上的衣物，「我是無所謂，反正有人包吃包住，總比回去面對學校那堆爛透了的專題研究強」

「你根本不知道事情有多嚴重」娜塔莎瞪著他，「就算我們惡魔不能傷害人類，但也有得是辦法折磨你！要是被激進份子發現了，你可是會生不如死！」

「哦？妳說惡魔不能傷害人類，又說可以折磨，那到底是怎樣？」

娜塔莎白了艾格雷瓦一眼，她拍掉身上的灰塵，「我幹嘛跟你解釋那麼多？反正我已經警告過你了，我半夜還得回博物館處理那堆該死的雕像，在我回來前，你最好乖乖待著」

「那我的吃食跟換洗衣物怎麼辦？」

「你問題怎麼一大堆！真把這當自己家了！」娜塔莎氣得跺腳

「妳把我帶來就該負起責任，就跟撿流浪貓狗回家一樣」艾格雷瓦聳聳肩

「我話可說在前頭！雖然我不夠小心是有一點責任，但說來說去要不是你隨便闖進來就不會有這種事了！」

「是妳辦事能力不行」艾格雷瓦平靜地補刀，「我只是路過，是妳要負全責」

娜塔莎被噎得說不出話，只能憤憤地從衣櫃最深處拖出一個漆黑的皮箱

皮箱被擦拭得一塵不染，與周遭凌亂的環境格格不入

「這段期間你就穿這些吧！可能對你來說不太合身，不過你一個寄人籬下吃軟飯的傢伙沒有挑剔的資格，何況這些衣服的料子都比你身上那套好太多了！」她打開箱子，裡面是整齊摺疊的男裝

艾格雷瓦雖對服裝品味沒有什麼概念，但在蘿絲父母的耳濡目染下他還是能夠看得出，那些衣裝雖然設計內斂，但布料的質地與精緻的做工就如娜塔莎所說，比常人所穿的要好得多

「然後吃的部分，我吃什麼你就跟著吃什麼，隨你愛吃不吃，不吃就餓死算了！」

艾格雷瓦盯著那箱衣服，調侃道：「妳為什麼會有男人的衣服？妳男友的？這麼貴重的衣服隨便給我穿沒問題嗎？」

「是我哥哥的」娜塔莎的聲音低了下去，手指輕輕撫過細緻的布料，眼神中閃過一絲灰暗，「……上面的人說，他違反了規定，所以被處死了」

儘管娜塔莎刻意保持平穩的語氣，艾格雷瓦還是能從那偽裝的音色聽出底下的情緒

但，這跟他要不要體貼他人情緒的是兩回事

「既然妳這麼重視，借我穿萬一弄髒了怎麼辦？妳哥也是藏匿人類被發現才死的嗎？」

「才不是！」這已經是娜塔莎今天不知道第幾次血壓升高了，拜此所賜，她悲傷的情緒再度被氣憤壓了下去，「你這人到底有沒有同理心！正常人這時候應該閉嘴，或者說聲抱歉！」

「我幹嘛道歉？是妳自己要提的」艾格雷瓦並不覺得自己有什麼不對

「你──算了算了！他們說，我哥哥喜歡上了天使」

「然後呢？這就被處死了？這麼嚴重？」

娜塔莎已經懶得對艾格雷瓦的態度生氣：「我們惡魔和天使可是對立的種族，這種跨種族的戀愛是不可能被允許的」

「是喔，那妳小心別愛上我。畢竟人類和惡魔也是跨種族」

娜塔莎直接翻了個白眼：「就你這個性，我覺得很安全」她轉身鋪了一個地鋪，「你睡這裡」

「為什麼是我睡地板？」

「這是我的家！」娜塔莎理直氣壯地說

艾格雷瓦挑眉：「是妳家又怎樣？偶爾換換口味睡地板也不錯啊，不然我就出去看看有沒有好心人願意收留我……」

娜塔莎咬牙切齒，權衡輕重後還是只能氣憤的坐到地鋪上：「滾上去睡！」

「既然妳這麼好心讓給我，那我就不客氣了，晚安！」

幾天後，娜塔莎實在忍無可忍，決定把艾格雷瓦扔回人界`
        },
        {
            title: "Chapter 2.5",
            showAfter: 1,   // ← 新增這行
            content: `那是艾格雷瓦被「軟禁」的第一個深夜

本打算睡飽再行動的娜塔莎在地舖上翻來覆去無法入眠，聽著床上傳來平穩的呼吸聲，心裡的火氣卻怎麼也壓不下去

這個人類完全沒有身為人質的自覺，不僅搶了她的床，甚至連一句「謝謝」都說得像施捨

──真想知道到底是怎樣的家庭才會教出這種兒子來！

娜塔莎輕手輕腳地坐起身，藉著窗外微弱且詭異的紅色月光，看向被墊在艾格雷瓦腦袋下的枕頭──她記得艾格雷瓦睡前曾把某物放在底下

她屏住呼吸，伸長了身子確認艾格雷瓦應該已經熟睡了，便將指尖微微顫抖地伸向枕頭底下

運氣不錯地，目標物正好沒有被艾格雷瓦的頭給壓住，娜塔莎小心翼翼地將艾格雷瓦的手機輕輕抽出

她原本做好了要花上好幾夜嘗試破解複雜密碼的心理準備，結果一滑開螢幕，直接就進入主畫面

──這傢伙，連設個密碼保護自己隱私都懶嗎？

娜塔莎蹲在地鋪邊，螢幕的微光將她的臉龐映得慘白

手機顯示訊號全無，但這不妨礙她翻閱通訊錄

在聯絡人資訊的最上方，使用者名稱欄位赫然寫著：艾格雷瓦

「艾格……艾格雷瓦」娜塔莎自言自語地低聲念出通訊錄上的全名，視線移向床上熟睡的少年，語氣裡帶著一種扳回一城的快意，「哼，以後知道要怎麼罵你了！」

此外，艾格雷瓦的社交圈娜塔莎想像的還要貧瘠，除了幾個標註為「打工處」或「外送」的號碼，頻繁聯絡人只有寥寥幾個：「伯父」、「伯母」，以及一個唯一擁有名字的聯絡人──「蘿絲」

這個「蘿絲」大概是聯絡人當中唯一有名字的存在了，娜塔莎進一步翻閱，手機中艾格雷瓦和這個「蘿絲」的簡訊紀錄還停留在今天早上：

蘿絲：『艾格，你到了嗎？我在大門口那邊等你』

『妳昨天不是叫我直接到展示廳找妳嗎？？』

蘿絲：『咦？對耶！你等我一下』

她看著聯絡人上面標註蘿絲的頭貼，那是個笑得很燦爛的黑髮女人，照片上隱約能看到她脖子上一抹鮮豔的玫瑰刺青

娜塔莎想起下午在走廊盡頭看到的那個匆忙身影

──是館內的工作人員嗎？希望這個時間別那麼湊巧還待在館內讓我遇上，否則就要把她也一起綁來團聚了

眼看時間也差不多，娜塔莎將手機原封不動地放回原位，接著打開自己的手機，在備忘錄記下剛才獲得的重大情報後便動身去處理原本未完成的工作`
        },
        {
            title: "Chapter 3",
            content: `咪`
        },
        {
            title: "Chapter 4",
            content: `咪`
        },
        {
            title: "Chapter 5",
            content: `咪`
        },
        {
            title: "Chapter 6",
            content: `咪`
        },
        {
            title: "Chapter 7",
            content: `咪`
        },
        {
            title: "Chapter 8",
            content: `咪`
        },
        {
            title: "Chapter 9",
            content: `嗚啦`
        }
    ];

    // ─────────────────────────────────────────────────────────────────
    // 狀態
    // ─────────────────────────────────────────────────────────────────
    const closedRecords       = new Set();
    const playedFadeRecords   = new Set();
    const visibleButtons      = new Set();   // 目前已顯示的按鈕 id
    const buttonVersionState  = {};          // btn id → 目前版本 key
    let   activePanelBtnId    = null;        // 目前開啟面板的按鈕 id

    // 初始化每顆按鈕的版本為 "default"
    Object.keys(globalButtonDefs).forEach(id => {
        buttonVersionState[id] = "default";
    });

    const newBadgeState = new Set(); // 目前帶有 NEW 標籤的按鈕 id

    // ─────────────────────────────────────────────────────────────────
    // DOM 參考
    // ─────────────────────────────────────────────────────────────────
    const buttonContainer    = document.querySelector('.button-container');
    const recordOverlay      = document.querySelector('.record-overlay');
    const closeRecordButton  = document.querySelector('.close-record-button');
    const recordContent      = document.querySelector('.record-content');
    const finalRecordButton  = document.querySelector('.final-record-button');
    const overlay            = document.querySelector('.overlay');
    const closeButton        = document.querySelector('.close-button');
    const backgroundOverlay  = document.querySelector('.background-overlay');
    const globalSideButtons  = document.getElementById('globalSideButtons');
    const globalSidePanel    = document.getElementById('globalSidePanel');
    const globalPanelTitle   = document.getElementById('globalPanelTitle');
    const globalPanelText    = document.getElementById('globalPanelText');
    const globalPanelClose   = document.getElementById('globalPanelClose');

    // ─────────────────────────────────────────────────────────────────
    // 全域按鈕渲染
    // ─────────────────────────────────────────────────────────────────
    function renderGlobalButtons() {
        // 重建所有按鈕 DOM（只保留 visible 的）
        globalSideButtons.innerHTML = '';

        Object.keys(globalButtonDefs).forEach(id => {
            if (!visibleButtons.has(id)) return;

            const def        = globalButtonDefs[id];
            const version    = buttonVersionState[id];
            const versionData= def.versions[version] || def.versions["default"];

            const btn = document.createElement('button');
            btn.className = 'global-side-btn visible';
            btn.dataset.btnId = id;

            // 標籤文字
            const labelSpan = document.createElement('span');
            labelSpan.textContent = def.label;
            btn.appendChild(labelSpan);

            // NEW 標籤
            if (newBadgeState.has(id)) {
                const badge = document.createElement('span');
                badge.className = 'new-badge';
                badge.textContent = 'NEW';
                btn.appendChild(badge);
            }

            if (activePanelBtnId === id) btn.classList.add('active');

            btn.addEventListener('click', () => {
                if (activePanelBtnId === id && globalSidePanel.classList.contains('active')) {
                    // 再次點擊同一顆 → 關閉面板
                    closeGlobalPanel();
                } else {
                    // 點擊後清除 NEW 標籤
                    if (newBadgeState.has(id)) {
                        newBadgeState.delete(id);
                        renderGlobalButtons(); // 立即移除徽章
                    }
                    openGlobalPanel(id, versionData);
                }
            });

            globalSideButtons.appendChild(btn);
        });
    }

    function openGlobalPanel(btnId, versionData) {
        activePanelBtnId = btnId;
        globalPanelTitle.textContent = versionData.title;
        globalPanelText.innerHTML    = versionData.content;
        globalSidePanel.classList.add('active');
        // 更新 active 樣式
        globalSideButtons.querySelectorAll('.global-side-btn').forEach(b => {
            b.classList.toggle('active', b.dataset.btnId === btnId);
        });
    }

    function closeGlobalPanel() {
        activePanelBtnId = null;
        globalSidePanel.classList.remove('active');
        globalSideButtons.querySelectorAll('.global-side-btn').forEach(b => b.classList.remove('active'));
    }

    globalPanelClose.addEventListener('click', closeGlobalPanel);

    // ─────────────────────────────────────────────────────────────────
    // 章節完成時：套用效果
    // ─────────────────────────────────────────────────────────────────
    function applyChapterEffect(chapterIndex) {
        const effect = chapterEffects[chapterIndex];
        if (!effect) return;

        // 1. 更新版本（無論按鈕是否已顯示）
        Object.entries(effect.updateVersion || {}).forEach(([btnId, newVersion]) => {
            buttonVersionState[btnId] = newVersion;
            // 已顯示的按鈕內容更新時標記 NEW
            if (visibleButtons.has(btnId)) {
                newBadgeState.add(btnId);
            }
        });

        // 2. 標記需要顯示的按鈕，首次出現也標記 NEW
        (effect.show || []).forEach(btnId => {
            visibleButtons.add(btnId);
            newBadgeState.add(btnId);
        });

        // 3. 如果面板正在顯示某顆被更新的按鈕，即時刷新面板內容
        if (activePanelBtnId && effect.updateVersion && effect.updateVersion[activePanelBtnId]) {
            const def      = globalButtonDefs[activePanelBtnId];
            const version  = buttonVersionState[activePanelBtnId];
            const vData    = def.versions[version] || def.versions["default"];
            globalPanelTitle.textContent = vData.title;
            globalPanelText.innerHTML    = vData.content;
        }

        // 4. 重新渲染按鈕列表
        renderGlobalButtons();
    }

    // ─────────────────────────────────────────────────────────────────
    // 淡入淡出動畫
    // ─────────────────────────────────────────────────────────────────
    function playFadeLines(lines, stayMs = 2000) {
        return new Promise(async (resolve) => {
            const screen = document.createElement('div');
            screen.className = 'fade-screen';

            const el = document.createElement('div');
            el.className = 'fade-line';
            screen.appendChild(el);
            document.body.appendChild(screen);

            for (const line of lines) {
                const text  = typeof line === 'string' ? line : line.text;
                const delay = typeof line === 'string' ? stayMs : line.stay;

                el.innerHTML = text.replace(/\n/g, '<br>');

                await nextFrame();
                el.style.opacity = '1';
                await waitMs(1000);
                await waitMs(delay);
                el.style.opacity = '0';
                await waitMs(1000);
            }

            screen.remove();
            resolve();
        });
    }

    function nextFrame() {
        return new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
    }
    function waitMs(ms) {
        return new Promise(r => setTimeout(r, ms));
    }

    // ─────────────────────────────────────────────────────────────────
    // 顯示章節
    // ─────────────────────────────────────────────────────────────────
    async function showRecord(index) {
        const record = recordContents[index];

        recordContent.innerHTML = record.content;
        recordOverlay.style.display = 'block';
        recordOverlay.scrollTop = 0;

        setTimeout(() => recordOverlay.classList.add('active'), 10);

        if (record.fadeLines && !playedFadeRecords.has(index)) {
            playedFadeRecords.add(index);
            recordContent.classList.add('hidden-content');
            closeRecordButton.style.pointerEvents = 'none';
            await playFadeLines(record.fadeLines, 2000);
            closeRecordButton.style.pointerEvents = '';
            recordContent.classList.remove('hidden-content');
        }
    }

    // ─────────────────────────────────────────────────────────────────
    // 打字機效果
    // ─────────────────────────────────────────────────────────────────
    function initializeTypingEffect() {
        return Array.from({length: 7}, (_, i) => {
            return new GlitchedWriter(`#output${i + 1}`, {
                ...presets.terminal,
                mode: "erase_smart",
                html: true
            });
        });
    }

    function updateCursors(currentIndex) {
        document.querySelectorAll('[id^="output"]').forEach((el) => {
            el.classList.remove('active-cursor', 'gw-writing');
        });
        const currentOutput = document.querySelector(`#output${currentIndex + 1}`);
        if (currentOutput) {
            currentOutput.classList.add('active-cursor', 'gw-writing');
        }
    }

    function setupCensor(id) {
        const censor = document.querySelector(`#${id}`);
        if (censor) {
            const newCensor = censor.cloneNode(true);
            censor.parentNode.replaceChild(newCensor, censor);
            let isRevealed = false;
            newCensor.addEventListener('mouseenter', function() {
                if (!isRevealed) {
                    this.textContent = this.getAttribute('data-text');
                    this.classList.add('revealed');
                    isRevealed = true;
                }
            });
        }
    }

    async function writeCensoredText(writer, text, censorId) {
        await writer.write(text);
        await wait(50);
        setupCensor(censorId);
    }

    async function executeTypingAnimation(writers) {
        const messages  = [
            `說實話，我並不是很喜歡留下實體記錄`,
            `但不得不承認，在將想法與情報轉化成文字的過程確實有助於整理和再次釐清思路`,
            ``,
            `我看見了那名成為魔王的惡魔的記憶`,
            `然而，當中存在著明顯的<strong id="censor1" class="censor-text" data-text="矛盾">███</strong>`,
            `不知是出於誰的意志，當中摻雜著<strong id="censor2" class="censor-text" data-text="捏造">███</strong>的片段`,
            `想來即使是紀錄在此處的內容，一旦觸及到關鍵要素也隨時會<strong id="censor3" class="censor-text" data-text="被竄改">███</strong>吧`
        ];
        const delays    = [1200, 2000, 2000, 1500, 1200, 1200, 2000];
        const censorIds = [null, null, null, null, 'censor1', 'censor2', 'censor3'];

        for (let i = 0; i < messages.length; i++) {
            updateCursors(i);
            if (censorIds[i]) {
                await writeCensoredText(writers[i], messages[i], censorIds[i]);
            } else {
                await writers[i].write(messages[i]);
            }
            if (i === messages.length - 1) {
                document.querySelector(`#output${i + 1}`).classList.add('active-cursor');
                closeButton.style.display = 'block';
            }
            await wait(delays[i]);
        }
    }

    function checkAllRecordsClosed() {
        if (closedRecords.size === recordContents.length) {
            finalRecordButton.style.display = 'block';
        }
    }

    // ─────────────────────────────────────────────────────────────────
    // 初始化
    // ─────────────────────────────────────────────────────────────────
    function initializePage() {
        const writers = initializeTypingEffect();
        buttonContainer.style.display = 'block';

        // 建立章節按鈕
        recordContents.forEach((record, index) => {
            const button = document.createElement('button');
            button.className = 'record-button';
            button.textContent = record.title;
            button.dataset.record = index;
            if (record.showAfter !== undefined) button.style.display = 'none';
            buttonContainer.appendChild(button);
        });

        buttonContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('record-button')) {
                document.querySelectorAll('.record-button.active')
                    .forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                closeGlobalPanel(); // 收回右側面板
                showRecord(parseInt(e.target.dataset.record));
            }
        });

        // 關閉章節 → 套用效果
        closeRecordButton.addEventListener('click', () => {
            recordOverlay.classList.remove('active');
            setTimeout(() => {
                recordOverlay.style.display = 'none';
                recordOverlay.scrollTop = 0;

                const currentButton = document.querySelector('.record-button.active');
                if (currentButton) {
                    const recordIndex = parseInt(currentButton.dataset.record);

                    if (!closedRecords.has(recordIndex)) {
                        closedRecords.add(recordIndex);
                        applyChapterEffect(recordIndex); // ← 套用全域按鈕效果
                        // 顯示以此章節為前置的按鈕
                        recordContents.forEach((r, i) => {
                            if (r.showAfter === recordIndex) {
                                const btn = buttonContainer.querySelector(`[data-record="${i}"]`);
                                if (btn) btn.style.display = '';
                            }
                        });
                        checkAllRecordsClosed();
                    }

                    currentButton.classList.remove('active');
                }
            }, 300);
        });

        finalRecordButton.addEventListener('click', async () => {
            backgroundOverlay.classList.add('active');
            await wait(500);
            overlay.style.display = 'block';
            executeTypingAnimation(writers);
        });

        closeButton.addEventListener('click', () => {
            overlay.classList.add('closing');
            setTimeout(() => {
                overlay.style.display = 'none';
                overlay.classList.remove('closing');
                closeButton.style.display = 'none';
                backgroundOverlay.classList.add('fade-out');
                buttonContainer.style.display = 'none';
                finalRecordButton.style.display = 'none';
                globalSidePanel.classList.remove('active');
                globalSideButtons.style.display = 'none';
                setTimeout(() => {
                    backgroundOverlay.classList.remove('active', 'fade-out');
                    // ── 跳轉至下一頁 ──
                    window.location.href = 'https://www.plurk.com/midorimimi';
                }, 500);
            }, 600);
        });
    }

    initializePage();
</script>
</body>
</html>


